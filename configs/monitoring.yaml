# XPPM DSS Monitoring Configuration
# Thresholds and alerting rules for production monitoring

monitoring:
  # Coverage thresholds
  coverage:
    target_min: 0.90  # 90% of decisions should come from surrogate
    warning_threshold: 0.85  # Warn if coverage drops below 85%
    critical_threshold: 0.80  # Critical if coverage drops below 80%

  fallback_rate:
    target_max: 0.05  # <5% should fallback to baseline
    warning_threshold: 0.10  # Warn if >10%
    critical_threshold: 0.20  # Critical if >20%

  override_rate:
    target_max: 0.10  # <10% should be overridden by humans
    warning_threshold: 0.15  # Warn if >15%
    critical_threshold: 0.25  # Critical if >25%
    spike_multiplier: 2.0  # Alert if >2x baseline

  # Drift detection thresholds
  drift:
    ood_rate:
      target_max: 0.05  # <5% OOD rate
      warning_threshold: 0.10  # Warn if >10%
      critical_threshold: 0.20  # Critical if >20%
      spike_threshold: 2.0  # Alert if >200% increase vs baseline

    coverage_drop:
      threshold: 0.20  # Alert if coverage drops >20% vs baseline
      baseline_days: 7  # Compare vs 7-day baseline

    override_spike:
      threshold: 1.0  # Alert if override rate increases >100% vs baseline
      baseline_days: 7

  # Performance thresholds
  latency:
    p50_target: 2.0  # p50 < 2ms
    p95_target: 10.0  # p95 < 10ms
    p99_target: 20.0  # p99 < 20ms
    p95_warning: 20.0  # Warn if p95 > 20ms
    p95_critical: 50.0  # Critical if p95 > 50ms

  # Operational thresholds
  operational:
    schema_error_rate:
      target_max: 0.001  # <0.1% schema errors
      warning_threshold: 0.005  # Warn if >0.5%
      critical_threshold: 0.01  # Critical if >1%

    total_requests_min: 10  # Minimum requests per day to consider valid

  # Retraining triggers
  retraining:
    drift_persistence_days: 3  # Trigger if drift detected for 3 consecutive days
    gain_drop_threshold: 0.30  # Trigger if expected gain drops >30%
    min_cases_for_retraining: 500  # Minimum cases needed for retraining

  # Feedback loop
  feedback:
    consolidation_frequency: "weekly"  # weekly or daily
    min_cases_for_consolidation: 100  # Minimum cases to consolidate
    min_cases_for_retraining: 500  # Minimum cases for retraining dataset

  # Alerting
  alerting:
    enabled: true
    email_enabled: false  # Set to true and configure SMTP if email alerts desired
    smtp:
      host: "smtp.gmail.com"
      port: 587
      user: ""  # Set via environment variable SMTP_USER
      password: ""  # Set via environment variable SMTP_PASSWORD
      from: "xppm-dss@example.com"
    recipients: []  # Set via environment variable ALERT_RECIPIENTS (comma-separated)

  # Dashboard
  dashboard:
    update_frequency: "daily"  # daily or weekly
    include_psi: false  # Include PSI calculations (requires more data)
